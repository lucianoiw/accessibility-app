# Plano: Screenshots de Viola√ß√µes

## Objetivo
Implementar captura de screenshots de elementos com problemas de acessibilidade para facilitar visualiza√ß√£o de viola√ß√µes visuais (contraste, fonte pequena, etc.).

## Abordagem

### H√≠brida: Autom√°tico para visuais + Sob demanda para outras

1. **Screenshot autom√°tico** durante auditoria para regras **visuais** (poucas)
2. **Sob demanda** via bot√£o "üì∏ Capturar" para as demais

### Formato: Elemento com padding (respiro)

```typescript
const box = await element.boundingBox();
const padding = 20; // pixels de respiro

await page.screenshot({
  clip: {
    x: Math.max(0, box.x - padding),
    y: Math.max(0, box.y - padding),
    width: box.width + (padding * 2),
    height: box.height + (padding * 2)
  }
});
```

### Quantidade: 1 screenshot por viola√ß√£o agregada

---

## Tarefas de Implementa√ß√£o

### 1. Migration - Schema do banco
**Arquivo:** `supabase/migrations/00023_add_violation_screenshots.sql`

- Adicionar campo `screenshot_url TEXT` na tabela `aggregated_violations`
- Criar policy para bucket `screenshots` no Supabase Storage

### 2. Configura√ß√£o Supabase Storage
**Local:** Dashboard Supabase ‚Üí Storage

- Criar bucket `screenshots` (p√∫blico)
- Configurar pol√≠tica de acesso

### 3. Definir regras visuais
**Arquivo:** `src/lib/audit/screenshot-rules.ts`

Regras que ter√£o screenshot autom√°tico:
```typescript
export const VISUAL_RULES = [
  // axe-core
  'color-contrast',
  'color-contrast-enhanced',
  // customizadas
  'fonte-muito-pequena',
  'texto-justificado',
  'texto-maiusculo-css',
  'br-excessivo-layout',
  'emag-tabela-layout',
]
```

### 4. Fun√ß√£o de captura de screenshot
**Arquivo:** `src/lib/audit/screenshot.ts`

```typescript
interface ScreenshotResult {
  buffer: Buffer
  width: number
  height: number
}

export async function captureElementScreenshot(
  page: Page,
  selector: string,
  options?: { padding?: number }
): Promise<ScreenshotResult | null>
```

- Localiza elemento pelo seletor
- Calcula bounding box com padding
- Captura screenshot da regi√£o
- Retorna Buffer da imagem

### 5. Fun√ß√£o de upload para Storage
**Arquivo:** `src/lib/audit/screenshot.ts`

```typescript
export async function uploadScreenshot(
  supabase: SupabaseClient,
  auditId: string,
  violationId: string,
  buffer: Buffer
): Promise<string>
```

- Path: `screenshots/{auditId}/{violationId}.png`
- Retorna URL p√∫blica

### 6. Modificar auditor.ts
**Arquivo:** `src/lib/audit/auditor.ts`

- Importar `VISUAL_RULES` e `captureElementScreenshot`
- Ap√≥s detectar viola√ß√£o visual, capturar screenshot
- Adicionar `screenshotBuffer` ao `ViolationResult`

### 7. Modificar trigger/audit.ts
**Arquivo:** `src/trigger/audit.ts`

- Para viola√ß√µes visuais:
  - Capturar screenshot ap√≥s auditoria da p√°gina
  - Upload para Storage
  - Salvar URL no `aggregated_violations`
- Estimativa de impacto: +100-300ms por viola√ß√£o visual

### 8. API de screenshot sob demanda
**Arquivo:** `src/app/api/violations/[id]/screenshot/route.ts`

```typescript
POST /api/violations/[id]/screenshot

Response:
{
  screenshotUrl: string
}
```

- Busca viola√ß√£o e URL da p√°gina
- Abre Playwright com auth do projeto
- Captura screenshot do elemento
- Upload e atualiza `screenshot_url`
- Retorna URL

### 9. Componente ScreenshotButton
**Arquivo:** `src/components/audit/screenshot-button.tsx`

- Se `screenshot_url` existe: mostra thumbnail + modal zoom
- Se n√£o existe: bot√£o "üì∏ Capturar" que chama API
- Loading state durante captura
- Erro se p√°gina mudou/indispon√≠vel

### 10. Componente ScreenshotModal
**Arquivo:** `src/components/audit/screenshot-modal.tsx`

- Modal com imagem em tamanho grande
- Zoom in/out
- Download da imagem

### 11. Integrar no ViolationCard
**Arquivo:** `src/app/[locale]/(dashboard)/projects/[id]/audits/[auditId]/violations-filter.tsx`

- Adicionar `<ScreenshotButton />` no card expandido
- Posi√ß√£o: pr√≥ximo ao c√≥digo do elemento

### 12. Tradu√ß√µes
**Arquivos:** `src/messages/{pt-BR,en,es}.json`

```json
{
  "ViolationsFilter": {
    "captureScreenshot": "Capturar print",
    "viewScreenshot": "Ver print",
    "screenshotLoading": "Capturando...",
    "screenshotError": "N√£o foi poss√≠vel capturar. A p√°gina pode ter mudado.",
    "screenshotZoom": "Ampliar",
    "screenshotDownload": "Baixar imagem"
  }
}
```

### 13. Tipos TypeScript
**Arquivo:** `src/types/index.ts`

- Adicionar `screenshot_url?: string` em `AggregatedViolation`

---

## Ordem de Execu√ß√£o

1. Migration + Configurar Storage
2. Tipos TypeScript
3. `screenshot-rules.ts` (lista de regras visuais)
4. `screenshot.ts` (fun√ß√µes de captura e upload)
5. Modificar `auditor.ts` (captura durante auditoria)
6. Modificar `trigger/audit.ts` (upload para visuais)
7. API de screenshot sob demanda
8. Componentes UI (button + modal)
9. Integrar no ViolationCard
10. Tradu√ß√µes
11. Testes manuais

---

## Considera√ß√µes

### Armazenamento
- Bucket: `screenshots` (p√∫blico)
- Path: `{auditId}/{violationId}.png`
- Tamanho estimado: 50-200KB por screenshot
- Limpeza: excluir ao deletar auditoria (cascade)

### Performance
- Screenshots autom√°ticos: apenas para ~6 regras visuais
- Impacto na auditoria: +100-300ms por viola√ß√£o visual
- Sob demanda: n√£o impacta tempo de auditoria

### Erros
- Elemento n√£o encontrado: log warning, continua sem screenshot
- P√°gina mudou: mostrar mensagem amig√°vel na UI
- Timeout: retry 1x, depois falha silenciosa

---

## Arquivos a Criar/Modificar

### Novos:
- `supabase/migrations/00023_add_violation_screenshots.sql`
- `src/lib/audit/screenshot-rules.ts`
- `src/lib/audit/screenshot.ts`
- `src/app/api/violations/[id]/screenshot/route.ts`
- `src/components/audit/screenshot-button.tsx`
- `src/components/audit/screenshot-modal.tsx`

### Modificar:
- `src/lib/audit/auditor.ts`
- `src/trigger/audit.ts`
- `src/types/database.ts` (ou regenerar)
- `src/app/[locale]/(dashboard)/projects/[id]/audits/[auditId]/violations-filter.tsx`
- `src/messages/pt-BR.json`
- `src/messages/en.json`
- `src/messages/es.json`
